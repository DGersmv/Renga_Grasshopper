# План разработки плагина получения стен из Renga в Grasshopper

## Цель
Создать функциональный плагин, который получает стены из Renga и отображает их baseline кривые и mesh геометрию в Grasshopper, используя прямой экспорт через DataExporter API.

## Текущий статус
- ✅ Базовая структура проектов создана
- ✅ TCP соединение между Renga и Grasshopper работает
- ✅ Компонент RengaGetWallsComponent создан
- ✅ Handler GetWallsHandler создан
- ✅ Исправлены ошибки компиляции
- ✅ Используется прямой экспорт через DataExporter.GetObjects3D()
- ✅ Каждая стена имеет уникальный GUID (id) из IModelObject.Id
- ⚠️ Требуется улучшение обработки типов Grid и Mesh
- ⚠️ Требуется тестирование и проверка координат

---

## Этап 1: Проверка сборки и базовой функциональности

### 1.1 Сборка проектов
- [ ] Убедиться, что оба проекта собираются без ошибок
- [ ] Проверить, что файлы копируются в нужные папки:
  - RengaGH.dll → `C:\Program Files\Renga Standard\Plugins\RengaGH\`
  - GrasshopperRNG.gha → `%APPDATA%\Grasshopper\Libraries\`

### 1.2 Проверка установки
- [ ] Запустить Renga и проверить, что плагин загружается
- [ ] Запустить Grasshopper и проверить, что компонент Renga Get Walls доступен
- [ ] Проверить, что компонент Renga Connect работает
- [ ] **Проверить, что компонент Renga Get Walls имеет уникальный GUID и не конфликтует с другими плагинами**

---

## Этап 2: Тестирование получения стен

### 2.1 Подготовка тестовой модели
- [ ] Создать простую модель в Renga с несколькими стенами:
  - Прямая стена
  - Полукруглая стена (дуга)
  - Стена с несколькими сегментами (если возможно)

### 2.2 Тестирование базового получения
- [ ] Запустить TCP сервер в Renga (через Server Settings)
- [ ] Подключиться через Renga Connect в Grasshopper
- [ ] Запустить Get Walls компонент
- [ ] Проверить, что стены получены (проверить выход Success и Message)

### 2.3 Проверка данных
- [ ] Проверить логи в `%APPDATA%\Renga\RengaGH_GetWalls.log`
- [ ] Проверить, что baseline данные присутствуют в ответе
- [ ] Проверить, что mesh данные присутствуют в ответе
- [ ] **Проверить, что каждая стена имеет уникальный GUID (id)**
- [ ] Убедиться, что GUID стабилен между запросами (не меняется)

---

## Этап 3: Проверка координат baseline

### 3.1 Проверка выравнивания
- [ ] Сравнить координаты baseline с положением стен в Renga
- [ ] Проверить, что baseline совпадает с mesh геометрией
- [ ] Убедиться, что нет смещения или двойного преобразования координат

### 3.2 Проверка типов кривых
- [ ] Прямые стены отображаются как линии
- [ ] Полукруглые стены отображаются как дуги (не прямые линии)
- [ ] Сложные стены отображаются корректно

### 3.3 Исправление проблем координат (если есть)
- [ ] Если baseline не совпадает - проверить логи координат
- [ ] Убедиться, что baseline2D используется напрямую (без CreateCurve3D)
- [ ] Проверить, что Z координата берется из placement.Origin.Z

---

## Этап 4: Проверка обработки дуг

### 4.1 Проверка дуг в Renga
- [ ] Создать стену с дугой в Renga
- [ ] Получить стену через Get Walls
- [ ] Проверить, что дуга отображается корректно в Grasshopper

### 4.2 Проверка sampled points для дуг
- [ ] Проверить, что sampled points генерируются правильно (50 точек)
- [ ] Убедиться, что используется тригонометрическое вычисление (Math.Cos, Math.Sin)
- [ ] Проверить, что дуга создается из sampled points в Grasshopper

### 4.3 Исправление проблем дуг (если есть)
- [ ] **КРИТИЧЕСКИ ВАЖНО: Линия арки ДОЛЖНА совпадать с mesh**
- [ ] **НЕ выбирать кратчайшую дугу** - использовать правильное направление из baseline2D
- [ ] **Строго соблюдать линию привязки стен** - baseline должен точно соответствовать положению стены
- [ ] Если дуга отображается как прямая - проверить sampled points
- [ ] Если дуга смещена - проверить вычисление углов
- [ ] Если дуга не совпадает с mesh - проверить направление дуги (не выбирать кратчайшую)
- [ ] Если дуга не создается - проверить конструктор Arc в Grasshopper
- [ ] **Проверить, что sampled points из CreateCurve3D соответствуют реальному направлению стены**

---

## Этап 5: Проверка mesh геометрии через DataExporter API

### 5.1 Проверка прямого экспорта mesh
- [ ] Убедиться, что используется `DataExporter.GetObjects3D()` для прямого экспорта
- [ ] Проверить, что `IExportedObject3D` содержит все необходимые данные
- [ ] Проверить структуру: `IExportedObject3D` → `IMesh` → `IGrid`
- [ ] Убедиться, что vertices и triangles извлекаются из IGrid
- [ ] **Проверить, что GUID стен используется для связи baseline и mesh данных**

### 5.2 Проверка типов Grid для стен
- [ ] Изучить типы Grid для стен (GridTypes.Wall):
  - FrontSide (передняя сторона)
  - BackSide (задняя сторона)
  - Bottom (низ)
  - Top (верх)
  - FirstButt (первый торец)
  - SecondButt (второй торец)
  - Reveal (откос)
  - Cut (разрез)
- [ ] Решить, какие типы Grid экспортировать (все или только основные)
- [ ] Добавить информацию о типе Grid в данные для Grasshopper

### 5.3 Проверка типов Mesh
- [ ] Изучить типы Mesh (MeshTypes):
  - Undefined
  - DoorReveal, DoorPanel, DoorTransom, DoorLining, DoorThreshold, DoorPlatband
  - WindowReveal, WindowPanel, WindowSill, WindowOutwardSill
- [ ] Решить, нужно ли фильтровать по типам Mesh
- [ ] Добавить информацию о типе Mesh в данные

### 5.4 Проверка отображения mesh
- [ ] Сравнить mesh с визуализацией стен в Renga
- [ ] Убедиться, что mesh совпадает с baseline
- [ ] Проверить, что mesh отображается корректно в Grasshopper
- [ ] Проверить, что разные типы Grid отображаются правильно

---

## Этап 6: Финальная проверка и оптимизация

### 6.1 Проверка всех типов стен
- [ ] Прямые стены
- [ ] Дуги
- [ ] Поликривые (если есть)
- [ ] Стены на разных уровнях

### 6.2 Проверка производительности
- [ ] Проверить время получения стен
- [ ] Проверить размер передаваемых данных
- [ ] Оптимизировать при необходимости

### 6.3 Обработка ошибок
- [ ] Проверить обработку отсутствующих стен
- [ ] Проверить обработку ошибок соединения
- [ ] Добавить информативные сообщения об ошибках

---

## Чеклист для каждого теста

При тестировании проверять:
1. ✅ Компонент получает данные от Renga
2. ✅ **Каждая стена имеет уникальный GUID (id)**
3. ✅ **GUID стабилен между запросами (не меняется)**
4. ✅ Baseline кривые создаются и отображаются
5. ✅ Координаты baseline совпадают с положением стен
6. ✅ Дуги отображаются как дуги, а не прямые линии
7. ✅ Mesh геометрия создается и отображается
8. ✅ Mesh совпадает с baseline
9. ✅ **Baseline и mesh связаны через один и тот же GUID**
10. ✅ Логи содержат полезную информацию
11. ✅ Нет ошибок в консоли Grasshopper

---

## Следующие шаги после успешного тестирования

1. Документировать использование плагина
2. Добавить примеры использования
3. Оптимизировать код при необходимости
4. Добавить дополнительные функции (если нужно)

---

## Известные проблемы и решения

### Проблема: Baseline не совпадает с положением стен
**Решение**: Использовать baseline2D напрямую как глобальные координаты, без CreateCurve3D

### Проблема: Дуги отображаются как прямые линии
**Решение**: Использовать тригонометрическое вычисление sampled points для дуг, создавать PolylineCurve из всех sampled points

### Проблема: Линия арки не совпадает с mesh (выбирается кратчайшая дуга)
**Решение**: 
- **НЕ выбирать кратчайшую дугу** - использовать правильное направление из baseline2D
- Использовать `CreateCurve3D` для получения sampled points в правильном направлении
- Если `endAngle < startAngle`, добавлять `2π` к `endAngle` (идти длинным путем), а не менять местами
- Строго соблюдать линию привязки стен - baseline должен точно соответствовать положению стены

### Проблема: Плагин не копируется автоматически
**Решение**: Запускать сборку от имени администратора или копировать вручную

### Проблема: Mesh не экспортируется правильно
**Решение**: Использовать прямой экспорт через `DataExporter.GetObjects3D()` → `IExportedObject3D` → `IMesh` → `IGrid`

## Требования к уникальным GUID

### Уникальный GUID для компонента Grasshopper ⭐ КРИТИЧЕСКИ ВАЖНО
- **Каждый компонент Grasshopper ДОЛЖЕН иметь уникальный GUID**
- GUID компонента задается через `ComponentGuid` property
- **GUID должен быть уникальным глобально** - не должен конфликтовать с другими плагинами
- Используется для идентификации компонента в Grasshopper
- При конфликте GUID компонент может не загрузиться или конфликтовать с другим плагином

### Текущие GUID компонентов:
- `RengaConnectComponent`: `6569e153-5300-47c4-a44e-418b4ebed893`
- `RengaCreateColumnsComponent`: `7c3bb3ab-6ac6-479c-a563-bb90b14ebdaf`
- `RengaGetWallsComponent`: `8d4e5f6a-7b8c-9d0e-1f2a-3b4c5d6e7f8a` ✅ (исправлен)

### Проверка уникальности GUID компонентов
- [ ] Убедиться, что все компоненты имеют разные GUID
- [ ] Проверить, что GUID не конфликтуют с другими плагинами
- [ ] Если обнаружен конфликт - сгенерировать новый уникальный GUID

---

## Требования к данным стен

### Уникальный GUID для каждой стены
- **Каждая стена должна иметь уникальный идентификатор (GUID/id)**
- GUID берется из `IModelObject.Id` в Renga
- GUID используется для:
  - Идентификации стен в Grasshopper
  - Связи baseline и mesh данных одной стены
  - Отслеживания изменений стен между запросами
  - Кэширования данных (если будет реализовано)
- **GUID должен быть стабильным** - не меняться между запросами для одной и той же стены

### Структура данных стены
```json
{
  "id": 100014,  // Уникальный GUID стены из Renga
  "name": "Стена: 200,00 мм",
  "position": { "x": 114.15, "y": -13.61, "z": 0 },
  "height": 3000.0,
  "thickness": 200.0,
  "baseline": { ... },  // Связано с этой стеной через id
  "mesh": [ ... ]       // Связано с этой стеной через id
}
```

---

## API Renga для экспорта геометрии

### Прямой экспорт через DataExporter
```csharp
var dataExporter = m_app.Project.DataExporter;
var exportedObjects3D = dataExporter.GetObjects3D();

for (int i = 0; i < exportedObjects3D.Count; i++)
{
    var exportedObj3D = exportedObjects3D.Get(i);
    int meshCount = exportedObj3D.MeshCount;
    
    for (int meshIdx = 0; meshIdx < meshCount; meshIdx++)
    {
        var mesh = exportedObj3D.GetMesh(meshIdx);
        var meshType = mesh.MeshType; // MeshTypes enum
        
        int gridCount = mesh.GridCount;
        for (int gridIdx = 0; gridIdx < gridCount; gridIdx++)
        {
            var grid = mesh.GetGrid(gridIdx);
            var gridType = grid.GridType; // GridTypes enum для стен
            
            // Извлечь vertices и triangles
            int vertexCount = grid.VertexCount;
            int triangleCount = grid.TriangleCount;
            
            for (int v = 0; v < vertexCount; v++)
            {
                var vertex = grid.GetVertex(v);
                // vertex.X, vertex.Y, vertex.Z
            }
            
            for (int t = 0; t < triangleCount; t++)
            {
                var triangle = grid.GetTriangle(t);
                // triangle.V0, triangle.V1, triangle.V2 (индексы вершин)
            }
        }
    }
}
```

### Типы Grid для стен (GridTypes.Wall)
- `FrontSide` - передняя сторона стены
- `BackSide` - задняя сторона стены
- `Bottom` - нижняя грань
- `Top` - верхняя грань
- `FirstButt` - первый торец
- `SecondButt` - второй торец
- `Reveal` - откос (для проемов)
- `Cut` - разрез

### Типы Mesh (MeshTypes)
- `Undefined` - неопределенный
- `DoorReveal`, `DoorPanel`, `DoorTransom`, `DoorLining`, `DoorThreshold`, `DoorPlatband` - элементы дверей
- `WindowReveal`, `WindowPanel`, `WindowSill`, `WindowOutwardSill` - элементы окон

---

## Логи для отладки

### Логи Renga
- Путь: `%APPDATA%\Renga\RengaGH_GetWalls.log`
- Содержит: координаты baseline2D, placement, sampled points

### Логи Grasshopper
- Проверять консоль Grasshopper на ошибки
- Проверять выходные параметры компонента (Success, Message)

---

## Критерии успеха

Плагин считается успешным, если:
1. ✅ **Все стены имеют уникальный GUID (id)**
2. ✅ **GUID стабилен между запросами**
3. ✅ Все типы стен получаются корректно
4. ✅ Baseline кривые совпадают с положением стен в Renga
5. ✅ Дуги отображаются правильно
6. ✅ Mesh геометрия отображается корректно
7. ✅ Baseline и mesh связаны через один и тот же GUID
8. ✅ Нет ошибок при работе
9. ✅ Производительность приемлемая

